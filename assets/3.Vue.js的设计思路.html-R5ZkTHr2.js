import{_ as n,c as s,o as a,d as e}from"./app-BOOpJRsI.js";const p="/assets/render-pipeline.CwxnH_lZ-CwxnH_lZ.png",t={},l=e(`<h2 id="_1-声明式地描述-ui" tabindex="-1"><a class="header-anchor" href="#_1-声明式地描述-ui"><span>1. 声明式地描述 UI</span></a></h2><h3 id="_1-1-声明式地描述-ui" tabindex="-1"><a class="header-anchor" href="#_1-1-声明式地描述-ui"><span>1.1 声明式地描述 UI</span></a></h3><ul><li>使用与 HTML 标签一致的方式来描述 DOM 元素，例如描述一个 div 标签时可以使用 <code>&lt;div&gt;&lt;/div&gt;</code></li><li>使用与 HTML 标签一致的方式来描述属性，例如 <code>&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</code></li><li>使用 <code>:</code> 或 <code>v-bind</code> 来描述动态绑定的属性，例如 <code>&lt;div :id=&quot;dynamicId&quot;&gt;&lt;/div&gt;</code></li><li>使用 <code>@</code> 或 <code>v-on</code> 来描述事件，例如点击事件 <code>&lt;div @click=&quot;handler&quot;&gt;&lt;/div&gt;</code></li><li>使用与 HTML 标签一致的方式来描述层级结构，例如一个具有 span 子节点的 div 标签 <code>&lt;div&gt;&lt;span&gt;&lt;/span&gt;&lt;/div&gt;</code></li></ul><p>可以看到，在 Vue.js 中，哪怕是事件，都有与之对应的描述方式。用户不需要手写任何命令式代码，这就是所谓的声明式地描述 UI。</p><h3 id="_1-2-使用-js-对象描述-ui" tabindex="-1"><a class="header-anchor" href="#_1-2-使用-js-对象描述-ui"><span>1.2 使用 JS 对象描述 UI</span></a></h3><p>除了上面这种使用模板来声明式地描述 UI 之外，我们还可以用 JavaScript 对象来描述:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 标签名称</span></span>
<span class="line">    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&#39;h1&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 标签属性</span></span>
<span class="line">    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">onClick</span><span class="token operator">:</span> handler</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 子节点</span></span>
<span class="line">    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&#39;span&#39;</span><span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-模板和-js-对象有何不同" tabindex="-1"><a class="header-anchor" href="#_1-3-模板和-js-对象有何不同"><span>1.3 模板和 JS 对象有何不同</span></a></h3><p>使用 JavaScript 对象描述 UI 更加灵活。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token comment">// h 标签的级别</span></span>
<span class="line"><span class="token keyword">let</span> level <span class="token operator">=</span> <span class="token number">3</span></span>
<span class="line"><span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">h</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>level<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">// h3 标签</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><span class="bg-grey" style="color:red;">使用 JavaScript 对象来描述 UI 的方式，其实就是所谓的虚拟 DOM。</span></p><div class="bg-slate-100">Vue.js 3 除了支持使用模板描述 UI 外，还支持使用虚拟 DOM 描述 UI。</div><p>其实我们在 Vue.js 组件中手写的渲染函数就是使用虚拟 DOM 来描述 UI 的，如以下代码所示：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>h<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;h1&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">onClick</span><span class="token operator">:</span> handler<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">// 虚拟 DOM   </span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>h</code> 函数就是一个辅助创建虚拟 DOM 的工具函数。</p><p>另外，这里有必要解释一下 <span style="color:red;"><strong>什么是组件的渲染函数</strong></span>。</p><p>一个组件要渲染的内容是通过渲染函数来描述的，也就是上面代码中的 render 函数，Vue.js 会根据组件的 <code>render</code> 函数的返回值拿到虚拟 DOM，然后就可以把组件的内容渲染出来了。</p><p><img src="`+p+`" alt="render-pipeline.CwxnH_lZ.png"></p><h2 id="_2-初识渲染器" tabindex="-1"><a class="header-anchor" href="#_2-初识渲染器"><span>2. 初识渲染器</span></a></h2><p><span style="color:red;">虚拟 DOM 其实就是用 JavaScript 对象来描述真实的 DOM 结构。 </span><br> 虚拟 DOM 是如何变成真实 DOM 并渲染到浏览器页面中的呢？<br> 这就用到了渲染器。<span style="color:red;"><strong>渲染器的作用就是把虚拟 DOM 渲染为真实 DOM</strong>。</span></p><h3 id="_2-1-编写一个渲染器" tabindex="-1"><a class="header-anchor" href="#_2-1-编写一个渲染器"><span>2.1 编写一个渲染器</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">function</span> <span class="token function">renderer</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 使用 vnode.tag 作为标签名称创建 DOM 元素</span></span>
<span class="line">    <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 遍历 vnode.props，将属性、事件添加到 DOM 元素</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> vnode<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 如果 key 以 on 开头，说明它是事件</span></span>
<span class="line">            <span class="token comment">// 事件名称 onClick ---&gt; click</span></span>
<span class="line">            el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                vnode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">// 事件处理函数</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 处理 children</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 如果 children 是字符串，说明它是元素的文本子节点</span></span>
<span class="line">        el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 递归地调用 renderer 函数渲染子节点，使用当前元素 el 作为挂载点</span></span>
<span class="line">        vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token function">renderer</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 将元素添加到挂载点下</span></span>
<span class="line">    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的 <code>renderer</code> 函数接收如下两个参数:</p><ol><li>vnode：虚拟 DOM 对象</li><li>container：一个真实 DOM 元素，作为挂载点，渲染器会把虚拟 DOM 渲染到该挂载点下。</li></ol><p>接下来，我们可以调用 <code>renderer</code> 函数：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token function">renderer</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token comment">// body 作为挂载点</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>渲染器 renderer 的实现思路，总体来说分为三步</p><ol><li>创建元素：把 vnode.tag 作为标签名称来创建 DOM 元素</li><li>为元素添加属性和事件：遍历 vnode.props 对象，如果 key 以 on 字符开头，说明它是一个事件</li><li>处理 children：如果 children 是一个数组，就递归地调用 renderer 继续渲染，注意，此时我们要把刚刚创建的元素作为挂载点（父节点）；如果 children 是字符串，则使用 createTextNode 函数创建一个文本节点，并将其添加到新创建的元素内。</li></ol><h2 id="_3-组件的本质" tabindex="-1"><a class="header-anchor" href="#_3-组件的本质"><span>3. 组件的本质</span></a></h2><p>虚拟 DOM 其实就是用来描述真实 DOM 的普通 JavaScript对象，渲染器会把这个对象渲染为真实 DOM 元素。</p><p>那么组件又是什么呢？<br> 组件和虚拟 DOM 有什么关系？<br> 渲染器如何渲染组件？</p><p>虚拟 DOM 除了能够描述真实 DOM 之外，还能够描述组件。<br> 例如使用 <code>{ tag: &#39;div&#39; }</code> 来描述 <code>&lt;div&gt;</code> 标签，但是组件并不是真实的 DOM 元素，那么如何使用虚拟 DOM 来描述呢？<br> 想要弄明白这个问题，就需要先搞清楚组件的本质是什么。一句话总结：<strong>组件就是一组 DOM 元素的封装，这组 DOM 元素就是组件要渲染的内容</strong>，<br> 因此我们可以定义一个函数来代表组件，而函数的返回值就代表组件要渲染的内容：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">MyComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">&#39;click me&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，组件的返回值也是虚拟 DOM，它代表组件要渲染的内容。搞清楚了组件的本质，我们就可以定义用虚拟 DOM 来描述组件了。 很简单，我们可以让虚拟 DOM 对象中的 tag 属性来存储组件函数</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">tag</span><span class="token operator">:</span> MyComponent</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>就像 <code>tag: &#39;div&#39;</code> 用来描述 <code>&lt;div&gt;</code> 标签一样，<code>tag: MyComponent</code> 用来描述组件，只不过此时的 <code>tag</code> 属性不是标签名称，而是组件函数。<br> 为了能够渲染组件，需要渲染器的支持。修改前面提到的 <code>renderer</code> 函数，如下所示：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">function</span> <span class="token function">renderer</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 说明 vnode 描述的是标签元素</span></span>
<span class="line">        <span class="token function">mountElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 说明 vnode 描述的是组件</span></span>
<span class="line">        <span class="token function">mountComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中 <code>mountElement</code> 函数与上文中 <code>renderer</code> 函数的内容一致,再来看 mountComponent 函数是如何实现的：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 调用组件函数，获取组件要渲染的内容（虚拟 DOM）</span></span>
<span class="line">    <span class="token keyword">const</span> subtree <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 递归地调用 renderer 渲染 subtree</span></span>
<span class="line">    <span class="token function">renderer</span><span class="token punctuation">(</span>subtree<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先调用 <code>vnode.tag</code> 函数，我们知道它其实就是组件函数本身，其返回值是虚拟 DOM，即组件要渲染的内容，这里我们称之为 <code>subtree</code>。<br> 既然 <code>subtree</code> 也是虚拟 DOM，那么直接调用 <code>renderer</code> 函数完成渲染即可。<br> 这里希望大家能够做到举一反三，例如组件一定得是函数吗？当然不是，我们完全可以使用一个 JavaScript 对象来表达组件，例如：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token comment">// MyComponent 是一个对象</span></span>
<span class="line"><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">&#39;click me&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该对象有一个函数，叫作 <code>render</code>，其返回值代表组件要渲染的内容。<br> 为了完成组件的渲染，我们需要修改 <code>renderer</code> 渲染器以及 <code>mountComponent</code> 函数。首先，修改渲染器的判断条件：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">function</span> <span class="token function">renderer</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">mountElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是对象，说明 vnode 描述的是组件</span></span>
<span class="line">        <span class="token function">mountComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着，修改 <code>mountComponent</code> 函数:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// vnode.tag 是组件对象，调用它的 render 函数得到组件要渲染的内容（虚拟 DOM）</span></span>
<span class="line">    <span class="token keyword">const</span> subtree <span class="token operator">=</span> vnode<span class="token punctuation">.</span>tag<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 递归地调用 renderer 渲染 subtree</span></span>
<span class="line">    <span class="token function">renderer</span><span class="token punctuation">(</span>subtree<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上述代码中，<code>vnode.tag</code> 是表达组件的对象，调用该对象的 <code>render</code> 函数得到组件要渲染的内容，也就是虚拟DOM。</p><h2 id="_4-模板的工作原理" tabindex="-1"><a class="header-anchor" href="#_4-模板的工作原理"><span>4. 模板的工作原理</span></a></h2><p>无论是手写虚拟 DOM（渲染函数）还是使用模板，都属于声明式地描述 UI，并且 Vue.js 同时支持这两种描述UI 的方式。<br> 上文中我们讲解了虚拟 DOM 是如何渲染成真实 DOM 的，那么模板是如何工作的呢？<br> 这就要提到Vue.js 框架中的另外一个重要组成部分：编译器。</p><p><span style="color:red;"><strong>编译器的作用其实就是将模板编译为渲染函数</strong></span>,对于编译器来说，模板就是一个普通的字符串，它会分析该字符串并生成一个功能与之相同的渲染函数：</p><div class="language-vue line-numbers-mode" data-highlighter="prismjs" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>handler<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    click me</span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span>
<span class="line">  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><span style="color:red;"><strong>其中 <code>&lt;template&gt;</code> 标签里的内容就是模板内容，编译器会把模板内容编译成渲染函数并添加到 <code>&lt;script&gt;</code> 标签块的组件对象上，所以最终在浏览器里运行的代码就是:</strong></span></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">onClick</span><span class="token operator">:</span> handler <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;click me&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以，无论是使用模板还是直接手写渲染函数，<span style="color:red;"><strong>对于一个组件来说，它要渲染的内容最终都是通过渲染函数产生的，然后渲染器再把渲染函数返回的虚拟 DOM 渲染为真实 DOM，这就是模板的工作原理，也是 Vue.js 渲染页面的流程。</strong></span></p><p>假设我们有如下模板：</p><div class="language-vue line-numbers-mode" data-highlighter="prismjs" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cls<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>根据上文的介绍，我们知道编译器会把这段代码编译成渲染函数：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 为了效果更加直观，这里没有使用 h 函数，而是直接采用了虚拟 DOM 对象</span></span>
<span class="line">    <span class="token comment">// 下面的代码等价于：</span></span>
<span class="line">    <span class="token comment">// return h(&#39;div&#39;, { id: &#39;foo&#39;, class: cls })</span></span>
<span class="line">   <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span></span>
<span class="line">     <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">       <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;foo&#39;</span><span class="token punctuation">,</span></span>
<span class="line">       <span class="token keyword">class</span><span class="token operator">:</span> cls</span>
<span class="line">     <span class="token punctuation">}</span></span>
<span class="line">   <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以发现，在这段代码中，<code>cls</code> 是一个变量，它可能会发生变化。<br> 我们知道渲染器的作用之一就是寻找并且只更新变化的内容，所以当变量 <code>cls</code> 的值发生变化时，渲染器会自行寻找变更点。<br> 对于渲染器来说，这个“寻找”的过程需要花费一些力气。那么从编译器的视角来看，它能否知道哪些内容会发生变化呢？<br> 如果编译器有能力分析动态内容，并在编译阶段把这些信息提取出来，然后直接交给渲染器，这样渲染器不就不需要花费大力气去寻找变更点了吗？<br> 这是个好想法并且能够实现。<br> Vue.js 的模板是有特点的，拿上面的模板来说，<br> 我们一眼就能看出其中 <code>id=&quot;foo&quot;</code> 是永远不会变化的，<br> 而 <code>:class=&quot;cls&quot;</code> 是一个 <code>v-bind</code> 绑定，它是可能发生变化的。所以编译器能识别出哪些是静态属性，哪些是动态属性，在生成代码的时候完全可以附带这些信息：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="line"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;foo&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token keyword">class</span><span class="token operator">:</span> cls</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">patchFlags</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// 假设数字 1 代表 class 是动态的</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上面的代码所示，在生成的虚拟 DOM 对象中多出了一个 <code>patchFlags</code> 属性，<br> 我们假设数字 <code>1</code> 代表 “class 是动态的”，<br> 这样渲染器看到这个标志时就知道：“哦，原来只有 class 属性会发生改变。”<br> 对于渲染器来说，就相当于省去了寻找变更点的工作量，性能自然就提升了。<br> 通过这个例子，我们了解到编译器和渲染器之间是存在信息交流的，它们互相配合使得性能进一步提升，而它们之间交流的媒介就是虚拟 DOM 对象。</p>`,60),c=[l];function o(i,u){return a(),s("div",null,c)}const d=n(t,[["render",o],["__file","3.Vue.js的设计思路.html.vue"]]),k=JSON.parse('{"path":"/Vuejs%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/3.Vue.js%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF.html","title":"","lang":"en-US","frontmatter":{"date":"2024年6月18日","category":["Vuejs的设计与实现"],"tag":["Vnode"],"archive":true},"headers":[{"level":2,"title":"1. 声明式地描述 UI","slug":"_1-声明式地描述-ui","link":"#_1-声明式地描述-ui","children":[{"level":3,"title":"1.1 声明式地描述 UI","slug":"_1-1-声明式地描述-ui","link":"#_1-1-声明式地描述-ui","children":[]},{"level":3,"title":"1.2 使用 JS 对象描述 UI","slug":"_1-2-使用-js-对象描述-ui","link":"#_1-2-使用-js-对象描述-ui","children":[]},{"level":3,"title":"1.3 模板和 JS 对象有何不同","slug":"_1-3-模板和-js-对象有何不同","link":"#_1-3-模板和-js-对象有何不同","children":[]}]},{"level":2,"title":"2. 初识渲染器","slug":"_2-初识渲染器","link":"#_2-初识渲染器","children":[{"level":3,"title":"2.1 编写一个渲染器","slug":"_2-1-编写一个渲染器","link":"#_2-1-编写一个渲染器","children":[]}]},{"level":2,"title":"3. 组件的本质","slug":"_3-组件的本质","link":"#_3-组件的本质","children":[]},{"level":2,"title":"4. 模板的工作原理","slug":"_4-模板的工作原理","link":"#_4-模板的工作原理","children":[]}],"git":{"updatedTime":1718723406000,"contributors":[{"name":"BaronYan","email":"1229598328@qq.com","commits":1}]},"filePathRelative":"Vuejs的设计与实现/3.Vue.js的设计思路.md","excerpt":"<h2>1. 声明式地描述 UI</h2>\\n<h3>1.1 声明式地描述 UI</h3>\\n<ul>\\n<li>使用与 HTML 标签一致的方式来描述 DOM 元素，例如描述一个 div 标签时可以使用 <code>&lt;div&gt;&lt;/div&gt;</code></li>\\n<li>使用与 HTML 标签一致的方式来描述属性，例如 <code>&lt;div id=\\"app\\"&gt;&lt;/div&gt;</code></li>\\n<li>使用 <code>:</code> 或 <code>v-bind</code> 来描述动态绑定的属性，例如 <code>&lt;div :id=\\"dynamicId\\"&gt;&lt;/div&gt;</code></li>\\n<li>使用 <code>@</code> 或 <code>v-on</code> 来描述事件，例如点击事件 <code>&lt;div @click=\\"handler\\"&gt;&lt;/div&gt;</code></li>\\n<li>使用与 HTML 标签一致的方式来描述层级结构，例如一个具有 span 子节点的 div 标签 <code>&lt;div&gt;&lt;span&gt;&lt;/span&gt;&lt;/div&gt;</code></li>\\n</ul>"}');export{d as comp,k as data};
